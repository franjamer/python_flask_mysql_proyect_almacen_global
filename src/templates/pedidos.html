{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <a href="{{ url_for('home_bp.menu') }}" class="btn btn-secondary mb-3">← Volver al menú principal</a>
    <h2>Nuevo Pedido</h2>
    <form method="post" class="mb-4">
        <div class="row">
            <div class="col-md-4">
                <label for="referencia_pedido">Referencia del pedido</label>
                <input
                    type="text"
                    class="form-control"
                    name="referencia_pedido"
                    required
                >
            </div>
            <div class="col-md-4">
                <label for="fecha_creacion">Fecha creación</label>
                <input
                    type="date"
                    class="form-control"
                    name="fecha_creacion"
                    required
                >
            </div>
        </div>
        <hr>
        <h5>Líneas de pedido</h5>
        <div id="lineas-pedido">
            <div class="row linea-pedido mb-2">
                <div class="col-md-3">
                    <label>Referencia repuesto</label>
                    <select class="form-control" name="referencia_articulo[]" required>
                        <option value="">Selecciona un repuesto</option>
                        {% for ref, nombre in inventario %}
                        <option value="{{ ref }}">{{ ref }} - {{ nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label>Cantidad pedida</label>
                    <input
                        type="number"
                        class="form-control"
                        name="cantidad_pedida[]"
                        min="1"
                        value="1"
                        required
                    >
                </div>
                <div class="col-md-2">
                    <label>Cantidad recibida</label>
                    <input
                        type="number"
                        class="form-control"
                        name="cantidad_recibida[]"
                        min="0"
                        value="0"
                    >
                </div>
                <div class="col-md-3">
                    <label>Fecha recibido</label>
                    <input type="date" class="form-control" name="fecha_recibido[]">
                </div>
            </div>
        </div>
        <button type="button" onclick="agregarLinea()">Añadir línea</button>
        <button type="submit" class="btn btn-primary mt-3">Guardar pedido</button>
    </form>
    <script>
    function agregarLinea() {
        var container = document.getElementById('lineas-pedido');
        var linea = container.querySelector('.linea-pedido').cloneNode(true);
        linea.querySelectorAll('input, select').forEach(function(el) { el.value = ''; });
        container.appendChild(linea);
    }
    </script>
        <div class="row">
        <!-- Tabla de pedidos globales -->
        <div class="col-md-5">
            <h4>Pedidos globales</h4>
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th style="width: 10%;">ID</th>
                        <th style="width: 30%;">Referencia</th>
                        <th style="width: 20%;">Fecha</th>
                        <th style="width: 10%;">Completo</th>
                        <th style="width: 10%;">Ver</th>
                        <th style="width: 10%;">Modificar</th>
                        <th style="width: 10%;">Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr>
                        <td>{{ pedido[0] }}</td>
                        <td>{{ pedido[1] }}</td>
                        <td>{{ pedido[2] }}</td>
                        <td>{{ 'Sí' if pedido[3] else 'No' }}</td>
                        <td>
                            <a href="{{ url_for('pedidos_bp.pedidos', pedido_id=pedido[0]) }}" class="btn btn-info btn-sm">Ver</a>
                        </td>
                        <td>
                            <a href="{{ url_for('pedidos_bp.modificar_pedido', pedido_id=pedido[0]) }}" class="btn btn-warning btn-sm">Modificar</a>
                        </td>
                        <td>
                            <form method="post" action="{{ url_for('pedidos_bp.eliminar_pedido', pedido_id=pedido[0]) }}" style="display:inline;" onsubmit="return confirm('¿Seguro que deseas eliminar este pedido?');">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Tabla de líneas de pedido -->
        <div class="col-md-7">
            {% if lineas %}
            <h4>Detalle del pedido</h4>
            <table class="table table-sm table-bordered">
                <thead>
                    <tr>
                        <th style="width: 25%;">Referencia repuesto</th>
                        <th style="width: 15%;">Pedida</th>
                        <th style="width: 15%;">Recibida</th>
                        <th style="width: 25%;">Fecha recibido</th>
                        <th style="width: 10%;">Completo</th>
                        <th style="width: 10%;">Acción</th>
                        <th style="width: 10%;">Eliminar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for linea in lineas %}
                    <tr>
                        <form method="post" action="{{ url_for('pedidos_bp.actualizar_linea', linea_id=linea[0], pedido_id=request.args.get('pedido_id')) }}">
                            <td>{{ linea[2] }}</td>
                            <td>
                                <input type="number" name="cantidad_pedida" value="{{ linea[3] }}" min="1" class="form-control form-control-sm" required>
                            </td>
                            <td>
                                <input type="number" name="cantidad_recibida" value="{{ linea[4] }}" min="0" class="form-control form-control-sm">
                            </td>
                            <td>
                                <input type="date" name="fecha_recibido" value="{{ linea[5]|default('', true) }}" class="form-control form-control-sm">
                            </td>
                            <td>
                                {{ 'Sí' if linea[6] else 'No' }}
                            </td>
                            <td>
                                <button type="submit" class="btn btn-warning btn-sm">Actualizar</button>
                            </td>
                        </form>
                        <td>
                            {% if lineas|length > 1 %}
                            <form method="post" action="{{ url_for('pedidos_bp.eliminar_linea', linea_id=linea[0], pedido_id=request.args.get('pedido_id')) }}" style="display:inline;" onsubmit="return confirm('¿Seguro que deseas eliminar esta línea?');">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}